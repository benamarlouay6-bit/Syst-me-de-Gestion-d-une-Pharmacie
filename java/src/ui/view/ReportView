package ui.view;

import dao.ProduitDAO;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableRow;
import javafx.scene.control.TableView;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;
import model.Produit;

import java.sql.SQLException;
import java.util.List;

public class ReportView {

    public void start(Stage stage) {

        TableView<Produit> table = new TableView<>();

                TableColumn<Produit, String> colNom =
                new TableColumn<>("Médicament");
        colNom.setCellValueFactory(
                new PropertyValueFactory<>("nom")
        );

        TableColumn<Produit, Integer> colQte =
                new TableColumn<>("Quantité");
        colQte.setCellValueFactory(
                new PropertyValueFactory<>("quantiteStock")
        );

        TableColumn<Produit, Integer> colSeuil =
                new TableColumn<>("Seuil");
        colSeuil.setCellValueFactory(
                new PropertyValueFactory<>("seuilAlerte")
        );

        TableColumn<Produit, String> colEtat =
                new TableColumn<>("État");
        colEtat.setCellValueFactory(
                new PropertyValueFactory<>("etatStock")
        );

        table.getColumns().addAll(
                colNom, colQte, colSeuil, colEtat
        );

        
        ProduitDAO dao = new ProduitDAO();
        try {
            List<Produit> produits = dao.getAllProduits();
            ObservableList<Produit> data =
                    FXCollections.observableArrayList(produits);
            table.setItems(data);
        } catch (SQLException e) {
            e.printStackTrace();
        }

        
        table.setRowFactory(tv -> new TableRow<>() {
            @Override
            protected void updateItem(Produit p, boolean empty) {
                super.updateItem(p, empty);

                if (p == null || empty) {
                    setStyle("");
                } else if (p.estInferieurAuSeuil()) {
                    setStyle("-fx-background-color: #ffcccc;");
                } else {
                    setStyle("");
                }
            }
        });
        Button btnRetour = new Button("Retour");
        btnRetour.getStyleClass().add("btn-rose");

        btnRetour.setOnAction(e -> new MenuView().start(stage));
        Label title = new Label("Rapport - État des stocks");
        title.getStyleClass().add("title");
        
        VBox root = new VBox(
                20,
                title,
                table,
                btnRetour
        );

        Scene scene = new Scene(root, 700, 400);

        stage.setScene(scene);
        stage.setTitle("Rapport – État des stocks");
        stage.show();
    }
}
