package ui.view;

import dao.VenteDAO;
import exception.StockInsuffisantException;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;
import model.Produit;

import java.sql.Date;
import java.time.LocalDate;

public class SaleView {

    public void start(Stage stage) {

        Label title = new Label("Vente Client");

        TextField txtMedicament = new TextField();
        txtMedicament.setPromptText("Nom médicament");

        TextField txtQuantite = new TextField();
        txtQuantite.setPromptText("Quantité vendue");

        TextField txtIdClient = new TextField();
        txtIdClient.setPromptText("ID client");

        Button btnVendre = new Button("Vendre");
        Button btnListe = new Button("Liste des ventes");
        Button btnRetour = new Button("Retour");

        btnVendre.setOnAction(e -> {
            try {
                VenteDAO dao = new VenteDAO();

                Produit produit = dao.enregistrerVente(
                        Date.valueOf(LocalDate.now()),
                        txtMedicament.getText(),
                        Integer.parseInt(txtQuantite.getText()),
                        Integer.parseInt(txtIdClient.getText())
                );

                if (produit.getQuantiteStock() < produit.getSeuilAlerte()) {
                    Alert a = new Alert(Alert.AlertType.WARNING);
                    a.setHeaderText(null);
                    a.setContentText(
                            "Attention : stock inférieur au seuil pour " +
                            produit.getNom()
                    );
                    a.show();
                }

                new ListeVenteView().start(stage);

            } catch (StockInsuffisantException ex) {
                Alert a = new Alert(Alert.AlertType.ERROR);
                a.setContentText(ex.getMessage());
                a.show();

            } catch (Exception ex) {
                Alert a = new Alert(Alert.AlertType.ERROR);
                a.setContentText(ex.getMessage());
                a.show();
            }
        });

        btnListe.setOnAction(e -> new ListeVenteView().start(stage));
        btnRetour.setOnAction(e -> new MenuView().start(stage));

        VBox root = new VBox(
                15,
                title,
                txtMedicament,
                txtQuantite,
                txtIdClient,
                btnVendre,
                btnListe,
                btnRetour
        );

        Scene scene = new Scene(root, 420, 380);
        stage.setScene(scene);
        stage.setTitle("Ventes");
        stage.show();
    }
}
